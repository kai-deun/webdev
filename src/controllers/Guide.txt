Handles request logic and prepares the response